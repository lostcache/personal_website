---
export interface Props {
  chart: string;
}
const { chart } = Astro.props;
const id = `mermaid-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="mermaid" id={id} data-original={chart}>{chart}</div>

<script>
  import mermaid from 'mermaid';

  const renderMermaid = async () => {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const theme = isDark ? 'dark' : 'default';

    // Update all diagrams to use current theme
    document.querySelectorAll('.mermaid:not([data-processed])').forEach(el => {
      const original = el.getAttribute('data-original');
      if (original && original.includes("'theme':'base'")) {
        const updated = original.replace(/'theme':'base'/, `'theme':'${theme}'`);
        el.innerHTML = updated;
      }
    });

    mermaid.initialize({
      startOnLoad: false
    });

    const diagrams = document.querySelectorAll('.mermaid:not([data-processed])');
    if (diagrams.length > 0) {
      await mermaid.run({ nodes: Array.from(diagrams) });
    }
  };

  const reRender = async () => {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const theme = isDark ? 'dark' : 'default';

    document.querySelectorAll('.mermaid[data-processed]').forEach(el => {
      const original = el.getAttribute('data-original');
      if (original) {
        el.removeAttribute('data-processed');
        const updated = original.replace(/'theme':'base'/, `'theme':'${theme}'`);
        el.innerHTML = updated;
      }
    });
    await renderMermaid();
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', renderMermaid);
  } else {
    renderMermaid();
  }

  new MutationObserver(reRender).observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['data-theme']
  });
</script>
